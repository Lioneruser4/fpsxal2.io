<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>SASKI FPS - Taktik SavaÅŸ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Orbitron:wght@700;900&display=swap');

  *{margin:0;padding:0;box-sizing:border-box;}
  :root{
    --blue:#1a6bff;--red:#ff2222;--gold:#ffd700;
    --bg:#080c10;--panel:#0d1520;--border:#1e3a5f;
    --text:#c8dff0;--accent:#00d4ff;
  }
  body{background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;overflow:hidden;height:100vh;width:100vw;}

  /* â”€â”€ SCREENS â”€â”€ */
  .screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;}
  .screen.hidden{display:none;}

  /* â”€â”€ MENU SCREEN â”€â”€ */
  #menuScreen{
    background: radial-gradient(ellipse at 50% 30%, #0a1a2e 0%, #020508 70%);
  }
  #menuScreen::before{
    content:'';position:absolute;inset:0;
    background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23162840' fill-opacity='0.3'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity:.5;
  }
  .logo{font-family:'Orbitron',monospace;font-size:clamp(32px,7vw,72px);font-weight:900;
    background:linear-gradient(135deg,#fff 0%,var(--accent) 50%,var(--blue) 100%);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    text-shadow:none;letter-spacing:4px;margin-bottom:8px;position:relative;}
  .logo-sub{font-size:clamp(10px,2vw,14px);letter-spacing:12px;color:#4a8ab0;text-transform:uppercase;margin-bottom:40px;}
  .player-info-box{background:rgba(13,21,32,0.85);border:1px solid var(--border);
    border-radius:12px;padding:24px 32px;margin-bottom:32px;text-align:center;
    backdrop-filter:blur(10px);min-width:320px;}
  .player-name-display{font-size:22px;font-weight:700;color:var(--accent);margin-top:8px;}
  .player-id-display{font-size:12px;color:#4a8ab0;margin-top:4px;}
  .menu-buttons{display:flex;flex-direction:column;gap:14px;width:100%;max-width:340px;}
  .btn{
    padding:16px 32px;border:none;border-radius:8px;cursor:pointer;
    font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;
    letter-spacing:2px;text-transform:uppercase;transition:all .2s;position:relative;overflow:hidden;
  }
  .btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.1),transparent);opacity:0;transition:.2s;}
  .btn:hover::before{opacity:1;}
  .btn:active{transform:scale(.97);}
  .btn-primary{background:linear-gradient(135deg,#1a3a8f,var(--blue));color:#fff;box-shadow:0 4px 20px rgba(26,107,255,.4);}
  .btn-primary:hover{box-shadow:0 6px 30px rgba(26,107,255,.7);transform:translateY(-2px);}
  .btn-secondary{background:linear-gradient(135deg,#1a1a2e,#2a2a4e);color:var(--text);border:1px solid var(--border);}
  .btn-secondary:hover{border-color:var(--accent);transform:translateY(-2px);}
  .btn-danger{background:linear-gradient(135deg,#5a0000,var(--red));color:#fff;box-shadow:0 4px 20px rgba(255,34,34,.3);}
  .btn-danger:hover{box-shadow:0 6px 30px rgba(255,34,34,.6);transform:translateY(-2px);}
  .btn-sm{padding:10px 20px;font-size:14px;}

  /* â”€â”€ ROOMS SCREEN â”€â”€ */
  #roomsScreen{background:radial-gradient(ellipse at 50% 20%,#0a1a2e,#020508);}
  .rooms-header{font-family:'Orbitron',monospace;font-size:28px;margin-bottom:24px;color:var(--accent);}
  .rooms-list{width:100%;max-width:600px;max-height:55vh;overflow-y:auto;margin-bottom:20px;}
  .room-card{
    background:rgba(13,21,32,.85);border:1px solid var(--border);border-radius:10px;
    padding:16px 20px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;
    cursor:pointer;transition:all .2s;
  }
  .room-card:hover{border-color:var(--accent);background:rgba(20,35,55,.9);}
  .room-name{font-size:18px;font-weight:700;}
  .room-teams{display:flex;gap:12px;font-size:14px;}
  .team-b{color:var(--blue);}
  .team-r{color:var(--red);}
  .room-full{opacity:.4;pointer-events:none;}
  .rooms-btns{display:flex;gap:12px;}

  /* â”€â”€ LOADING â”€â”€ */
  #loadingScreen{background:#020508;z-index:200;}
  .loading-text{font-family:'Orbitron',monospace;font-size:24px;color:var(--accent);margin-bottom:20px;letter-spacing:4px;}
  .loading-bar{width:300px;height:4px;background:#1a2a3a;border-radius:2px;overflow:hidden;}
  .loading-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--accent));animation:loadFill 2s ease-in-out forwards;}
  @keyframes loadFill{from{width:0%}to{width:100%}}
  .status-msg{margin-top:16px;font-size:14px;color:#4a8ab0;letter-spacing:2px;}

  /* â”€â”€ HUD â”€â”€ */
  #hud{position:fixed;inset:0;pointer-events:none;z-index:50;}

  /* Health */
  #hudHealth{position:absolute;bottom:24px;left:24px;pointer-events:none;}
  .hud-label{font-size:11px;letter-spacing:3px;color:#4a8ab0;margin-bottom:6px;}
  .health-bar-wrap{width:220px;height:16px;background:rgba(0,0,0,.6);border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,.1);}
  .health-bar{height:100%;border-radius:8px;transition:width .2s,background .3s;background:linear-gradient(90deg,#00cc44,#00ff55);}
  .health-text{font-family:'Orbitron',monospace;font-size:22px;font-weight:700;color:#fff;margin-top:4px;}

  /* Ammo / weapon */
  #hudWeapon{position:absolute;bottom:24px;right:24px;text-align:right;pointer-events:none;}
  .weapon-name{font-family:'Orbitron',monospace;font-size:18px;color:var(--accent);}
  .ammo-display{font-size:32px;font-weight:700;color:#fff;font-family:'Orbitron',monospace;}

  /* Crosshair */
  #crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;}

  /* Kill log */
  #killLog{position:absolute;top:70px;right:20px;width:280px;pointer-events:none;}
  .kill-entry{background:rgba(0,0,0,.7);border-radius:6px;padding:6px 12px;margin-bottom:5px;
    font-size:13px;animation:fadeKill 3s forwards;}
  @keyframes fadeKill{0%{opacity:1;transform:translateX(20px)}80%{opacity:1}100%{opacity:0;transform:translateX(20px)}}
  .kill-blue{border-left:3px solid var(--blue);}
  .kill-red{border-left:3px solid var(--red);}

  /* Scoreboard */
  #scoreHud{position:absolute;top:16px;left:50%;transform:translateX(-50%);display:flex;gap:0;pointer-events:none;}
  .score-box{padding:8px 28px;font-family:'Orbitron',monospace;font-size:20px;font-weight:700;
    background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.1);}
  .score-box.blue-score{color:var(--blue);border-radius:8px 0 0 8px;border-right:none;}
  .score-box.red-score{color:var(--red);border-radius:0 8px 8px 0;border-left:none;}
  .score-divider{padding:8px 14px;background:rgba(0,0,0,.7);color:#888;font-family:'Orbitron',monospace;font-size:18px;border-top:1px solid rgba(255,255,255,.1);border-bottom:1px solid rgba(255,255,255,.1);}

  /* Minimap */
  #minimap{position:absolute;bottom:24px;left:50%;transform:translateX(-50%);border:2px solid var(--border);border-radius:6px;background:rgba(0,0,0,.7);}

  /* Room info */
  #roomHud{position:absolute;top:70px;left:20px;background:rgba(0,0,0,.6);border-radius:8px;padding:10px 16px;font-size:13px;pointer-events:none;}
  .room-hud-title{font-family:'Orbitron',monospace;font-size:11px;color:var(--accent);margin-bottom:4px;}

  /* Damage indicator */
  #dmgFlash{position:fixed;inset:0;pointer-events:none;z-index:60;opacity:0;transition:opacity .05s;border:8px solid rgba(255,0,0,0);}
  
  /* Kill confirm */
  #killConfirm{position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);
    font-family:'Orbitron',monospace;font-size:14px;color:var(--gold);letter-spacing:3px;
    pointer-events:none;z-index:70;opacity:0;text-align:center;}

  /* Death screen */
  #deathScreen{position:fixed;inset:0;background:rgba(180,0,0,.15);z-index:80;
    display:flex;align-items:center;justify-content:center;display:none;}
  .death-msg{font-family:'Orbitron',monospace;font-size:48px;color:#ff2222;text-shadow:0 0 40px #ff2222;animation:pulse .8s infinite alternate;}
  @keyframes pulse{from{opacity:.6}to{opacity:1}}

  /* GAME CANVAS */
  #gameCanvas{position:fixed;inset:0;width:100%;height:100%;}

  /* Scrollbar */
  ::-webkit-scrollbar{width:6px;}
  ::-webkit-scrollbar-track{background:rgba(0,0,0,.2);}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

  /* Hit marker */
  .hit-marker{position:fixed;pointer-events:none;z-index:65;}

  /* Mobile controls */
  #mobileControls{display:none;position:fixed;z-index:55;}
  @media (max-width:768px) and (pointer:coarse){
    #mobileControls{display:block;}
    #hudWeapon{bottom:160px;}
    #hudHealth{bottom:160px;}
  }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREENS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- LOADING -->
<div class="screen" id="loadingScreen">
  <div class="loading-text">SASKI FPS</div>
  <div class="loading-bar"><div class="loading-fill"></div></div>
  <div class="status-msg" id="loadStatus">SUNUCUYA BAÄLANILIYOR...</div>
</div>

<!-- MENU -->
<div class="screen hidden" id="menuScreen">
  <div class="logo">SASKI FPS</div>
  <div class="logo-sub">Taktik SavaÅŸ ArenasÄ±</div>
  <div class="player-info-box">
    <div class="hud-label">ASKER KÄ°MLÄ°ÄÄ°</div>
    <div class="player-name-display" id="displayName">YÃ¼kleniyor...</div>
    <div class="player-id-display" id="displayId"></div>
  </div>
  <div class="menu-buttons">
    <button class="btn btn-primary" onclick="Game.findGame()">âš”ï¸ OYUN BUL</button>
    <button class="btn btn-secondary" onclick="showScreen('roomsScreen');loadRooms()">ğŸ  ODALAR</button>
    <button class="btn btn-danger" onclick="Game.createRoom()">â• ODA OLUÅTUR</button>
  </div>
</div>

<!-- ROOMS -->
<div class="screen hidden" id="roomsScreen">
  <div class="rooms-header">ğŸ  ODALAR</div>
  <div class="rooms-list" id="roomsList">
    <div style="text-align:center;color:#4a8ab0;padding:40px;">Odalar yÃ¼kleniyor...</div>
  </div>
  <div class="rooms-btns">
    <button class="btn btn-primary btn-sm" onclick="loadRooms()">ğŸ”„ YENÄ°LE</button>
    <button class="btn btn-secondary btn-sm" onclick="showScreen('menuScreen')">â† GERÄ°</button>
  </div>
</div>

<!-- GAME CANVAS -->
<canvas id="gameCanvas" class="hidden"></canvas>

<!-- HUD -->
<div id="hud" class="hidden">
  <!-- Score -->
  <div id="scoreHud">
    <div class="score-box blue-score">MAVÄ° <span id="scoreBlue">0</span></div>
    <div class="score-divider">VS</div>
    <div class="score-box red-score"><span id="scoreRed">0</span> KIRMIZI</div>
  </div>

  <!-- Room Info -->
  <div id="roomHud">
    <div class="room-hud-title">ODA</div>
    <div id="roomHudId" style="color:#fff;font-size:14px;font-weight:700;"></div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <span class="team-b">MAVÄ°: <b id="hudBlue">0</b></span>
      <span style="color:#444;">|</span>
      <span class="team-r">KIRMIZI: <b id="hudRed">0</b></span>
    </div>
  </div>

  <!-- Health -->
  <div id="hudHealth">
    <div class="hud-label">SAÄLIK</div>
    <div class="health-bar-wrap"><div class="health-bar" id="healthBar" style="width:100%"></div></div>
    <div class="health-text" id="healthText">100</div>
  </div>

  <!-- Weapon -->
  <div id="hudWeapon">
    <div class="weapon-name">SERVÄ°S RÄ°FLESÄ°</div>
    <div class="ammo-display">âˆ</div>
  </div>

  <!-- Crosshair -->
  <div id="crosshair">
    <svg width="40" height="40" viewBox="0 0 40 40">
      <line x1="20" y1="2" x2="20" y2="13" stroke="#fff" stroke-width="2" stroke-opacity="0.9"/>
      <line x1="20" y1="27" x2="20" y2="38" stroke="#fff" stroke-width="2" stroke-opacity="0.9"/>
      <line x1="2" y1="20" x2="13" y2="20" stroke="#fff" stroke-width="2" stroke-opacity="0.9"/>
      <line x1="27" y1="20" x2="38" y2="20" stroke="#fff" stroke-width="2" stroke-opacity="0.9"/>
      <circle cx="20" cy="20" r="2" fill="#fff" fill-opacity="0.7"/>
    </svg>
  </div>

  <!-- Kill Log -->
  <div id="killLog"></div>

  <!-- Minimap -->
  <canvas id="minimap" width="160" height="160"></canvas>
</div>

<!-- Damage Flash -->
<div id="dmgFlash"></div>

<!-- Kill Confirm -->
<div id="killConfirm">Ã–LDÃœRÃœLDÃœ!</div>

<!-- Death Screen -->
<div id="deathScreen">
  <div class="death-msg">Ã–LDÃœNÃ¼Z</div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   SASKI FPS - Complete Game Client
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SERVER_URL = 'https://saskioyunu-1-2d6i.onrender.com';
const MINIMAP_SIZE = 160;

// â”€â”€ Telegram WebApp Integration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TG = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
let myName = 'Asker';
let myId = 'player_' + Math.random().toString(36).slice(2,9);

if (TG) {
  TG.expand();
  TG.ready();
  const user = TG.initDataUnsafe && TG.initDataUnsafe.user;
  if (user) {
    myName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
    myId = 'tg_' + user.id;
  }
} else {
  // Fallback: localStorage persist
  const stored = localStorage.getItem('saskiFpsPlayer');
  if (stored) {
    const p = JSON.parse(stored);
    myName = p.name; myId = p.id;
  } else {
    myName = 'Asker_' + Math.random().toString(36).slice(2,6).toUpperCase();
    localStorage.setItem('saskiFpsPlayer', JSON.stringify({ name: myName, id: myId }));
  }
}

document.getElementById('displayName').textContent = myName;
document.getElementById('displayId').textContent = myId;

// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
  const el = document.getElementById(id);
  if (el) el.classList.remove('hidden');
}

function lerp(a, b, t) { return a + (b - a) * t; }
function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
function dist2(a, b) { return Math.sqrt((a.x-b.x)**2 + (a.y-b.y)**2); }

// â”€â”€ Socket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let socket;
function connectSocket() {
  socket = io(SERVER_URL, {
    reconnection: true,
    reconnectionAttempts: Infinity,
    reconnectionDelay: 1000,
    reconnectionDelayMax: 5000,
    transports: ['websocket', 'polling']
  });

  socket.on('connect', () => {
    console.log('[Socket] Connected:', socket.id);
    document.getElementById('loadStatus').textContent = 'BAÄLANTI KURULDU!';
    setTimeout(() => { showScreen('menuScreen'); }, 800);
  });

  socket.on('connect_error', (e) => {
    document.getElementById('loadStatus').textContent = 'BAÄLANTI HATASI - YENÄ°DEN DENENIYOR...';
  });

  socket.on('disconnect', (reason) => {
    console.warn('[Socket] Disconnected:', reason);
    // Auto-reconnect handled by socket.io
  });

  socket.on('reconnect', () => {
    if (Game.state === 'playing' && Game.roomId) {
      socket.emit('reconnectPlayer', { roomId: Game.roomId, playerId: socket.id });
    }
  });

  socket.on('reconnected', (data) => Game.onJoined(data));
  socket.on('reconnectFailed', () => showScreen('menuScreen'));

  socket.on('joined', (data) => Game.onJoined(data));
  socket.on('roomFull', () => alert('Oda dolu! BaÅŸka oda deneyin.'));
  socket.on('roomsList', (list) => renderRooms(list));
  socket.on('playerJoined', (p) => Game.addPlayer(p));
  socket.on('playerLeft', (id) => Game.removePlayer(id));
  socket.on('playerMoved', (d) => Game.updatePlayer(d));
  socket.on('playerDied', (d) => Game.onDeath(d));
  socket.on('playerRespawned', (p) => Game.onRespawn(p));
  socket.on('hit', (d) => Game.onHit(d));
  socket.on('shot', (d) => Game.onShot(d));
  socket.on('bullets', (bl) => Game.remoteBullets = bl);
  socket.on('roomUpdate', (d) => Game.onRoomUpdate(d));
}

// â”€â”€ Rooms UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadRooms() {
  if (socket) socket.emit('getRooms');
}

function renderRooms(list) {
  const el = document.getElementById('roomsList');
  if (!list || list.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:#4a8ab0;padding:40px;">HenÃ¼z oda yok. Bir tane oluÅŸturun!</div>';
    return;
  }
  el.innerHTML = list.map(r => {
    const full = r.blue >= 10 && r.red >= 10;
    return `
    <div class="room-card ${full ? 'room-full' : ''}" onclick="Game.joinRoom('${r.id}')">
      <div>
        <div class="room-name">ğŸ  ${r.id}</div>
        <div style="font-size:12px;color:#4a8ab0;margin-top:2px;">Mavi: ${r.blue}/10 &nbsp; KÄ±rmÄ±zÄ±: ${r.red}/10</div>
      </div>
      <div class="room-teams">
        <span class="team-b">â—</span><span style="font-size:13px">${r.blue}</span>
        <span class="team-r">â—</span><span style="font-size:13px">${r.red}</span>
        ${full ? '<span style="color:#ff4444;font-size:12px;">DOLU</span>' : '<span class="btn btn-primary btn-sm" style="pointer-events:none">GÄ°R</span>'}
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   GAME ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Game = {
  state: 'menu',
  canvas: null, ctx: null,
  miniCtx: null,
  walls: [], mapW: 3200, mapH: 3200,
  players: new Map(),
  myId: null, myTeam: null, roomId: null,
  me: null,
  bullets: [],
  remoteBullets: [],
  particles: [],
  explosions: [],
  hitMarkers: [],
  input: { keys: {}, mouseX: 0, mouseY: 0, shoot: false, angle: 0 },
  camera: { x: 0, y: 0 },
  dead: false,
  killLog: [],
  animFrame: 0,
  walkCycle: 0,
  lastInputSend: 0,

  init() {
    this.canvas = document.getElementById('gameCanvas');
    this.ctx = this.canvas.getContext('2d');
    this.miniCtx = document.getElementById('minimap').getContext('2d');
    this.setupEvents();
    this.resize();
    window.addEventListener('resize', () => this.resize());
  },

  resize() {
    if (!this.canvas) return;
    this.canvas.width = window.innerWidth;
    this.canvas.height = window.innerHeight;
  },

  setupEvents() {
    window.addEventListener('keydown', e => {
      this.input.keys[e.key.toLowerCase()] = true;
      this.input.keys[e.key] = true;
      if (e.key === ' ') { e.preventDefault(); this.input.keys[' '] = true; }
    });
    window.addEventListener('keyup', e => {
      this.input.keys[e.key.toLowerCase()] = false;
      this.input.keys[e.key] = false;
    });
    window.addEventListener('mousemove', e => {
      this.input.mouseX = e.clientX;
      this.input.mouseY = e.clientY;
      if (this.state === 'playing' && this.me) {
        const cx = window.innerWidth / 2, cy = window.innerHeight / 2;
        this.input.angle = Math.atan2(e.clientY - cy, e.clientX - cx);
        this.me.angle = this.input.angle;
      }
    });
    window.addEventListener('mousedown', e => {
      if (e.button === 0) this.input.shoot = true;
    });
    window.addEventListener('mouseup', e => {
      if (e.button === 0) this.input.shoot = false;
    });
    window.addEventListener('contextmenu', e => e.preventDefault());

    // Pointer lock
    this.canvas.addEventListener('click', () => {
      if (this.state === 'playing') this.canvas.requestPointerLock();
    });
    document.addEventListener('pointerlockchange', () => {
      this.pointerLocked = document.pointerLockElement === this.canvas;
    });
    document.addEventListener('mousemove', e => {
      if (this.pointerLocked && this.me && this.state === 'playing') {
        this.me.angle += e.movementX * 0.003;
        this.input.angle = this.me.angle;
      }
    });
  },

  findGame() { if (socket) socket.emit('findGame', { name: myName, id: myId }); },
  joinRoom(id) { if (socket) socket.emit('joinRoom', { roomId: id, name: myName, id: myId }); },
  createRoom() { if (socket) socket.emit('createRoom', { name: myName, id: myId }); },

  onJoined(data) {
    this.walls = data.walls;
    this.mapW = data.mapWidth;
    this.mapH = data.mapHeight;
    this.myId = data.playerId;
    this.myTeam = data.team;
    this.roomId = data.roomId;
    this.players.clear();
    this.dead = false;

    (data.players || []).forEach(p => {
      const pl = { ...p };
      pl.renderX = p.x; pl.renderY = p.y;
      this.players.set(p.id, pl);
    });

    this.me = this.players.get(data.playerId);
    if (!this.me) {
      this.me = {
        id: data.playerId, name: myName,
        x: data.mapWidth / 2, y: data.mapHeight / 2,
        angle: 0, hp: 100, team: data.team,
        state: 'idle', dead: false, kills: 0, deaths: 0,
        renderX: data.mapWidth / 2, renderY: data.mapHeight / 2
      };
      this.players.set(data.playerId, this.me);
    }
    this.me.renderX = this.me.x;
    this.me.renderY = this.me.y;

    if (data.scores) this.updateScoreUI(data.scores);
    document.getElementById('roomHudId').textContent = data.roomId;
    this.state = 'playing';
    showScreen(null);
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.getElementById('gameCanvas').classList.remove('hidden');
    document.getElementById('hud').classList.remove('hidden');
    this.canvas.requestPointerLock();
    if (!this._loopRunning) { this._loopRunning = true; this.loop(); }
  },

  addPlayer(p) {
    const pl = { ...p, renderX: p.x, renderY: p.y };
    this.players.set(p.id, pl);
  },

  removePlayer(id) { this.players.delete(id); },

  updatePlayer(d) {
    const p = this.players.get(d.id);
    if (p) {
      p.x = d.x; p.y = d.y;
      if (d.angle !== undefined) p.angle = d.angle;
      if (d.state) p.state = d.state;
      if (d.hp !== undefined) p.hp = d.hp;
    }
  },

  onDeath(d) {
    const victim = this.players.get(d.id);
    const killer = this.players.get(d.killerId);
    if (victim) { victim.dead = true; victim.hp = 0; }

    if (d.scores) this.updateScoreUI(d.scores);

    // Kill log
    const vName = victim ? victim.name : '?';
    const kName = killer ? killer.name : '?';
    const team = killer ? killer.team : 'blue';
    this.addKillLog(kName, vName, team);

    if (d.id === this.myId) {
      this.dead = true;
      document.getElementById('deathScreen').style.display = 'flex';
    }
    if (d.killerId === this.myId) {
      this.showKillConfirm('DÃœÅMAN Ã–LDÃœRÃœLDÃœ!');
    }

    // Corpse explosion particles
    if (victim) this.spawnDeathParticles(victim.x, victim.y, victim.team);
  },

  onRespawn(p) {
    const pl = this.players.get(p.id);
    if (pl) Object.assign(pl, p);
    if (p.id === this.myId) {
      this.me = pl;
      this.dead = false;
      document.getElementById('deathScreen').style.display = 'none';
      this.updateHealthUI(100);
    }
  },

  onHit(d) {
    const victim = this.players.get(d.victim);
    if (victim) victim.hp = Math.max(0, victim.hp - d.dmg);

    if (d.victim === this.myId) {
      this.flashDamage();
      this.updateHealthUI(this.me ? this.me.hp : 0);
    }
    // Hit particles
    this.spawnHitParticles(d.x, d.y, d.part);
  },

  onShot(d) {
    this.spawnMuzzleFlash(d.x, d.y, d.angle);
  },

  onRoomUpdate(d) {
    document.getElementById('hudBlue').textContent = d.blue;
    document.getElementById('hudRed').textContent = d.red;
  },

  updateScoreUI(sc) {
    document.getElementById('scoreBlue').textContent = sc.blue || 0;
    document.getElementById('scoreRed').textContent = sc.red || 0;
  },

  updateHealthUI(hp) {
    const pct = clamp(hp, 0, 100);
    const bar = document.getElementById('healthBar');
    bar.style.width = pct + '%';
    if (pct > 60) bar.style.background = 'linear-gradient(90deg,#00cc44,#00ff55)';
    else if (pct > 30) bar.style.background = 'linear-gradient(90deg,#cc8800,#ffaa00)';
    else bar.style.background = 'linear-gradient(90deg,#cc0000,#ff2222)';
    document.getElementById('healthText').textContent = Math.ceil(pct);
  },

  addKillLog(killer, victim, team) {
    const log = document.getElementById('killLog');
    const el = document.createElement('div');
    el.className = `kill-entry kill-${team}`;
    el.innerHTML = `<span style="color:${team==='blue'?'#5599ff':'#ff5555'}">${killer}</span> ğŸ’€ <span style="color:#aaa">${victim}</span>`;
    log.prepend(el);
    setTimeout(() => el.remove(), 3000);
  },

  flashDamage() {
    const f = document.getElementById('dmgFlash');
    f.style.boxShadow = 'inset 0 0 80px rgba(255,0,0,0.5)';
    f.style.opacity = '1';
    setTimeout(() => { f.style.opacity = '0'; f.style.boxShadow = 'none'; }, 200);
  },

  showKillConfirm(msg) {
    const el = document.getElementById('killConfirm');
    el.textContent = msg;
    el.style.opacity = '1';
    setTimeout(() => el.style.opacity = '0', 1200);
  },

  // â”€â”€ Input Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sendInput() {
    if (!socket || this.dead || !this.me) return;
    const now = Date.now();
    if (now - this.lastInputSend < 33) return; // ~30hz
    this.lastInputSend = now;
    socket.emit('input', {
      keys: {
        w: !!this.input.keys['w'], s: !!this.input.keys['s'],
        a: !!this.input.keys['a'], d: !!this.input.keys['d'],
        ArrowUp: !!this.input.keys['arrowup'], ArrowDown: !!this.input.keys['arrowdown'],
        ArrowLeft: !!this.input.keys['arrowleft'], ArrowRight: !!this.input.keys['arrowright'],
        ' ': !!this.input.keys[' '],
      },
      angle: this.me.angle,
      shoot: this.input.shoot
    });
  },

  // â”€â”€ PARTICLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  spawnHitParticles(x, y, part) {
    const color = part === 'head' ? '#ff8800' : part === 'feet' ? '#ffcc44' : '#ff4444';
    for (let i = 0; i < 8; i++) {
      const a = Math.random() * Math.PI * 2;
      const spd = 1 + Math.random() * 3;
      this.particles.push({ x, y, vx: Math.cos(a)*spd, vy: Math.sin(a)*spd, life: 25, color, size: 3+Math.random()*3 });
    }
  },

  spawnDeathParticles(x, y, team) {
    const color = team === 'blue' ? '#4488ff' : '#ff4444';
    for (let i = 0; i < 20; i++) {
      const a = Math.random() * Math.PI * 2;
      const spd = 1 + Math.random() * 5;
      this.particles.push({ x, y, vx: Math.cos(a)*spd, vy: Math.sin(a)*spd, life: 45, color, size: 4+Math.random()*6 });
    }
  },

  spawnMuzzleFlash(x, y, angle) {
    for (let i = 0; i < 5; i++) {
      const a = angle + (Math.random()-0.5)*0.4;
      const spd = 2 + Math.random() * 4;
      this.particles.push({ x, y, vx: Math.cos(a)*spd, vy: Math.sin(a)*spd, life: 15, color: '#ffcc44', size: 3+Math.random()*3 });
    }
  },

  updateParticles() {
    for (const p of this.particles) {
      p.x += p.vx; p.y += p.vy;
      p.vy += 0.1;
      p.life--;
    }
    this.particles = this.particles.filter(p => p.life > 0);
  },

  // â”€â”€ CAMERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  updateCamera() {
    if (!this.me) return;
    const cw = this.canvas.width, ch = this.canvas.height;
    const tx = this.me.x - cw/2, ty = this.me.y - ch/2;
    this.camera.x = lerp(this.camera.x, tx, 0.12);
    this.camera.y = lerp(this.camera.y, ty, 0.12);
    this.camera.x = clamp(this.camera.x, 0, this.mapW - cw);
    this.camera.y = clamp(this.camera.y, 0, this.mapH - ch);
  },

  // â”€â”€ LOCAL MOVEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  updateLocalPlayer() {
    if (!this.me || this.dead) return;
    const spd = 3.8;
    const k = this.input.keys;
    let moved = false;
    let nx = this.me.x, ny = this.me.y;
    if (k['w'] || k['arrowup'])    { ny -= spd; moved = true; }
    if (k['s'] || k['arrowdown'])  { ny += spd; moved = true; }
    if (k['a'] || k['arrowleft'])  { nx -= spd; moved = true; }
    if (k['d'] || k['arrowright']) { nx += spd; moved = true; }

    if (!this.collidesWall(nx, this.me.y)) this.me.x = clamp(nx, 50, this.mapW-50);
    if (!this.collidesWall(this.me.x, ny)) this.me.y = clamp(ny, 50, this.mapH-50);

    if (k[' '] && this.me.state !== 'jump') {
      this.me.state = 'jump';
      setTimeout(() => { if (this.me && this.me.state === 'jump') this.me.state = 'idle'; }, 550);
    } else if (moved && this.me.state !== 'jump') this.me.state = 'walk';
    else if (!moved && this.me.state !== 'jump') this.me.state = 'idle';

    this.updateHealthUI(this.me.hp);
  },

  collidesWall(x, y) {
    const r = 15;
    for (const w of this.walls) {
      if (x-r < w.x+w.w && x+r > w.x && y-r < w.y+w.h && y+r > w.y) return true;
    }
    return false;
  },

  // â”€â”€ WALK CYCLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  getWalkOffset(p) {
    const t = Date.now() / 100;
    if (p.state === 'walk') return Math.sin(t * 3) * 3;
    if (p.state === 'jump') return -10;
    return 0;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RENDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  loop() {
    this.animFrame++;
    if (this.state === 'playing') {
      this.updateLocalPlayer();
      this.updateCamera();
      this.updateParticles();
      this.sendInput();
      this.render();
      this.renderMinimap();
    }
    requestAnimationFrame(() => this.loop());
  },

  render() {
    const ctx = this.ctx;
    const cw = this.canvas.width, ch = this.canvas.height;
    ctx.clearRect(0, 0, cw, ch);

    ctx.save();
    ctx.translate(-this.camera.x, -this.camera.y);

    // â”€â”€ Floor (Backrooms tiled) â”€â”€
    const tileSize = 80;
    const sx = Math.floor(this.camera.x / tileSize) * tileSize;
    const sy = Math.floor(this.camera.y / tileSize) * tileSize;
    for (let x = sx; x < this.camera.x + cw + tileSize; x += tileSize) {
      for (let y = sy; y < this.camera.y + ch + tileSize; y += tileSize) {
        const odd = (Math.floor(x/tileSize) + Math.floor(y/tileSize)) % 2;
        ctx.fillStyle = odd ? '#0e1520' : '#0b1218';
        ctx.fillRect(x, y, tileSize, tileSize);
        // Grid lines
        ctx.strokeStyle = 'rgba(30,58,95,0.3)';
        ctx.strokeRect(x, y, tileSize, tileSize);
      }
    }

    // â”€â”€ Walls â”€â”€
    for (const w of this.walls) {
      if (w.x + w.w < this.camera.x || w.x > this.camera.x + cw ||
          w.y + w.h < this.camera.y || w.y > this.camera.y + ch) continue;

      // Wall shadow
      ctx.fillStyle = 'rgba(0,0,0,0.4)';
      ctx.fillRect(w.x+4, w.y+4, w.w, w.h);

      // Wall body
      const grd = ctx.createLinearGradient(w.x, w.y, w.x, w.y+w.h);
      grd.addColorStop(0, '#2a3f5f');
      grd.addColorStop(1, '#1a2d45');
      ctx.fillStyle = grd;
      ctx.fillRect(w.x, w.y, w.w, w.h);

      // Wall top highlight
      ctx.fillStyle = 'rgba(100,160,220,0.15)';
      ctx.fillRect(w.x, w.y, w.w, 3);

      // Wall outline
      ctx.strokeStyle = '#1e3a5f';
      ctx.lineWidth = 1;
      ctx.strokeRect(w.x, w.y, w.w, w.h);
    }

    // â”€â”€ Particles â”€â”€
    for (const p of this.particles) {
      ctx.globalAlpha = p.life / 30;
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size * (p.life/30), 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // â”€â”€ Remote Bullets (visual only) â”€â”€
    for (const b of this.remoteBullets) {
      ctx.save();
      ctx.shadowBlur = 8;
      ctx.shadowColor = b.team === 'blue' ? '#4499ff' : '#ff4444';
      ctx.fillStyle = b.team === 'blue' ? '#88ccff' : '#ffaaaa';
      ctx.beginPath();
      ctx.arc(b.x, b.y, 3, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    // â”€â”€ Players â”€â”€
    for (const [id, p] of this.players) {
      if (p.dead) continue;
      // Smooth interpolation for remote players
      if (id !== this.myId) {
        p.renderX = p.renderX !== undefined ? lerp(p.renderX, p.x, 0.25) : p.x;
        p.renderY = p.renderY !== undefined ? lerp(p.renderY, p.y, 0.25) : p.y;
      } else {
        p.renderX = p.x; p.renderY = p.y;
      }
      this.drawSoldier(ctx, p, id === this.myId);
    }

    ctx.restore();

    // â”€â”€ Team area indicators â”€â”€
    const blueX = this.mapW * 0.05 - this.camera.x;
    const redX = this.mapW * 0.85 - this.camera.x;
    if (blueX > -100 && blueX < cw + 100) {
      ctx.fillStyle = 'rgba(26,107,255,0.06)';
      ctx.fillRect(Math.max(0, blueX), 0, this.mapW * 0.12 * (cw/this.mapW), ch);
    }
    if (redX > -100 && redX < cw + 100) {
      ctx.fillStyle = 'rgba(255,34,34,0.06)';
      ctx.fillRect(Math.max(0, redX), 0, this.mapW * 0.12 * (cw/this.mapW), ch);
    }
  },

  // â”€â”€ SOLDIER DRAWING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  drawSoldier(ctx, p, isMe) {
    const x = p.renderX, y = p.renderY;
    const team = p.team;
    const angle = p.angle;
    const walkOff = this.getWalkOffset(p);
    const isJump = p.state === 'jump';

    ctx.save();
    ctx.translate(x, y + walkOff);

    // Shadow
    ctx.globalAlpha = 0.3;
    ctx.fillStyle = '#000';
    ctx.beginPath();
    ctx.ellipse(0, 18, 14, 5, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;

    // Rotate body toward movement direction but draw facing up
    const bodyAngle = angle;

    // â”€â”€ Legs â”€â”€
    const legSwing = p.state === 'walk' ? Math.sin(Date.now()/90) * 8 : 0;
    const legColor = team === 'blue' ? '#1a3a8a' : '#6a1a1a';
    const legHighlight = team === 'blue' ? '#2550b0' : '#8a2828';

    // Left leg
    ctx.save();
    ctx.translate(-5, 8);
    ctx.rotate(legSwing * 0.08);
    ctx.fillStyle = legColor;
    ctx.fillRect(-4, 0, 8, 16);
    ctx.fillStyle = legHighlight;
    ctx.fillRect(-4, 0, 3, 16);
    // Boot
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(-5, 14, 10, 5);
    ctx.restore();

    // Right leg
    ctx.save();
    ctx.translate(5, 8);
    ctx.rotate(-legSwing * 0.08);
    ctx.fillStyle = legColor;
    ctx.fillRect(-4, 0, 8, 16);
    ctx.fillStyle = legHighlight;
    ctx.fillRect(-4, 0, 3, 16);
    // Boot
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(-5, 14, 10, 5);
    ctx.restore();

    // â”€â”€ Torso (body armor) â”€â”€
    const bodyColor = team === 'blue' ? '#1a4aaa' : '#aa1a1a';
    const bodyHighlight = team === 'blue' ? '#2260cc' : '#cc2222';
    const armorColor = team === 'blue' ? '#0a2060' : '#600a0a';

    ctx.fillStyle = bodyColor;
    ctx.fillRect(-9, -10, 18, 20);

    // Armor plate
    ctx.fillStyle = armorColor;
    ctx.fillRect(-7, -8, 14, 12);

    // Armor highlight
    ctx.fillStyle = bodyHighlight;
    ctx.fillRect(-9, -10, 4, 20);

    // Shoulder pads
    ctx.fillStyle = armorColor;
    ctx.fillRect(-13, -10, 5, 9);
    ctx.fillRect(8, -10, 5, 9);
    ctx.fillStyle = bodyHighlight;
    ctx.fillRect(-13, -10, 2, 9);
    ctx.fillRect(8, -10, 2, 9);

    // Belt
    ctx.fillStyle = '#111';
    ctx.fillRect(-9, 8, 18, 3);
    ctx.fillStyle = '#444';
    ctx.fillRect(-2, 8, 4, 3);

    // â”€â”€ Arms (rotate toward aim angle) â”€â”€
    ctx.save();
    ctx.rotate(angle + Math.PI/2);
    // Upper arm
    ctx.fillStyle = bodyColor;
    ctx.fillRect(-3, -4, 7, 14);
    // Glove
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(-3, 10, 7, 5);
    // Rifle
    ctx.fillStyle = '#2a2a2a';
    ctx.fillRect(1, 14, 5, 22);
    ctx.fillStyle = '#111';
    ctx.fillRect(1, 14, 2, 22);
    // Muzzle
    ctx.fillStyle = '#444';
    ctx.fillRect(0, 34, 7, 4);
    // Muzzle flash
    if (this.input.shoot && isMe && Date.now() % 400 < 60) {
      ctx.fillStyle = '#ffdd00';
      ctx.globalAlpha = 0.9;
      ctx.beginPath();
      ctx.arc(3.5, 40, 5, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;
    }
    ctx.restore();

    // â”€â”€ Head â”€â”€
    const skinColor = '#c8a070';
    const helmetColor = team === 'blue' ? '#0a2060' : '#600a0a';
    const helmetHighlight = team === 'blue' ? '#1a4090' : '#901a1a';

    // Neck
    ctx.fillStyle = skinColor;
    ctx.fillRect(-4, -18, 8, 8);

    // Head
    ctx.fillStyle = skinColor;
    ctx.fillRect(-8, -32, 16, 16);

    // Helmet
    ctx.fillStyle = helmetColor;
    ctx.beginPath();
    ctx.ellipse(0, -28, 10, 9, 0, Math.PI, 0);
    ctx.fill();
    ctx.fillRect(-10, -28, 20, 5);

    ctx.fillStyle = helmetHighlight;
    ctx.fillRect(-10, -28, 4, 5);
    ctx.beginPath();
    ctx.ellipse(0, -28, 10, 9, 0, Math.PI, 0);
    ctx.strokeStyle = helmetHighlight;
    ctx.lineWidth = 1.5;
    ctx.stroke();

    // Goggles
    ctx.fillStyle = '#223344';
    ctx.fillRect(-8, -30, 6, 4);
    ctx.fillRect(2, -30, 6, 4);
    ctx.fillStyle = 'rgba(100,180,255,0.4)';
    ctx.fillRect(-8, -30, 6, 4);
    ctx.fillRect(2, -30, 6, 4);

    // Face
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(-7, -24, 14, 6); // balaclava

    // Camo pattern
    const camoDots = team === 'blue' ? 'rgba(0,50,120,0.3)' : 'rgba(120,0,0,0.3)';
    ctx.fillStyle = camoDots;
    for (let cx = -8; cx < 8; cx += 5) {
      for (let cy = -10; cy < 8; cy += 5) {
        if (Math.sin(cx*7 + cy*3) > 0.3) ctx.fillRect(cx, cy, 3, 3);
      }
    }

    // â”€â”€ Name tag â”€â”€
    if (!isMe) {
      ctx.fillStyle = team === 'blue' ? 'rgba(26,107,255,0.85)' : 'rgba(255,34,34,0.85)';
      const nameW = Math.min(p.name.length * 6 + 10, 100);
      ctx.fillRect(-nameW/2, -48, nameW, 14);
      ctx.fillStyle = '#fff';
      ctx.font = '10px Rajdhani';
      ctx.textAlign = 'center';
      ctx.fillText(p.name.substring(0,12), 0, -37);
    }

    // â”€â”€ HP bar â”€â”€
    const hpPct = p.hp / 100;
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(-18, -56, 36, 5);
    ctx.fillStyle = hpPct > 0.6 ? '#00dd44' : hpPct > 0.3 ? '#ffaa00' : '#ff2222';
    ctx.fillRect(-18, -56, 36 * hpPct, 5);

    // â”€â”€ My indicator â”€â”€
    if (isMe) {
      ctx.strokeStyle = team === 'blue' ? 'rgba(100,160,255,0.8)' : 'rgba(255,100,100,0.8)';
      ctx.lineWidth = 2;
      ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.arc(0, 0, 22, 0, Math.PI*2);
      ctx.stroke();
      ctx.setLineDash([]);
    }

    ctx.restore();
  },

  // â”€â”€ MINIMAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  renderMinimap() {
    const ctx = this.miniCtx;
    const S = MINIMAP_SIZE;
    const scaleX = S / this.mapW, scaleY = S / this.mapH;
    ctx.clearRect(0, 0, S, S);

    // Background
    ctx.fillStyle = 'rgba(8,12,16,0.95)';
    ctx.fillRect(0, 0, S, S);

    // Walls
    ctx.fillStyle = '#1e3a5f';
    for (const w of this.walls) {
      ctx.fillRect(w.x*scaleX, w.y*scaleY, Math.max(1,w.w*scaleX), Math.max(1,w.h*scaleY));
    }

    // Players
    for (const [id, p] of this.players) {
      if (p.dead) continue;
      ctx.fillStyle = p.team === 'blue' ? '#4499ff' : '#ff4444';
      const mx = p.x * scaleX, my = p.y * scaleY;
      ctx.beginPath();
      if (id === this.myId) {
        ctx.fillStyle = '#ffffff';
        ctx.arc(mx, my, 3.5, 0, Math.PI*2);
      } else {
        ctx.arc(mx, my, 2.5, 0, Math.PI*2);
      }
      ctx.fill();
    }

    // Viewport box
    if (this.me) {
      ctx.strokeStyle = 'rgba(255,255,255,0.2)';
      ctx.lineWidth = 1;
      const vx = this.camera.x * scaleX, vy = this.camera.y * scaleY;
      const vw = window.innerWidth * scaleX, vh = window.innerHeight * scaleY;
      ctx.strokeRect(vx, vy, vw, vh);
    }
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', () => {
  Game.init();
  connectSocket();

  // Expose for buttons
  window.Game = Game;
  window.loadRooms = loadRooms;
  window.showScreen = showScreen;
});
</script>

<!-- Telegram WebApp SDK (optional, loads if in Telegram) -->
<script>
  // Dynamically load TG SDK if we're in telegram
  if (navigator.userAgent.includes('TelegramBot') || window.location.search.includes('tgWebApp')) {
    const s = document.createElement('script');
    s.src = 'https://telegram.org/js/telegram-web-app.js';
    document.head.appendChild(s);
  }
</script>
</body>
</html>
